<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  
  <head>
    <title>Main Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" type="text/css">
    <link rel="stylesheet" href="custom.css" />
    <script src="http://code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
  </head>
  
  <body>
    <!-- Home -->
    <div data-role="page" id="page1" data-theme="b">
      <script language="javascript" type="text/javascript">
        var timeout = 0;
		var schedState;
		
        function pad(n, width, z) {
          z = z || '0';
          n = n + '';
          return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
        }		
		
        $('#page1').on('pagebeforeshow', function () {
			$.ajax("json/state", {
				async: false, 
				dataType: "json", 
				error: function () { 
					alert ("Communications Failure" ); 
				}, success: function (data) {
						schedState = data.run;
						var dt = new Date(data.timenow*1000);
						$('#version').text("V"+data.version);
						$('#timediv').empty().append('' + pad(dt.getUTCHours(),2) + ':' + pad(dt.getUTCMinutes(),2) + ':' + pad(dt.getUTCSeconds(),2) + ' ' + pad(dt.getUTCFullYear(),4) + '/' + pad(dt.getUTCMonth()+1,2) + '/' + pad(dt.getUTCDate(),2) );
						checkAnim(data);
					}
			});
			
          $.getJSON("json/zones", function (data) {
			var output = '<li data-role="list-divider" id="lst-dev">Zones (Scheduling is ' + schedState + ')' + 
							'<span class="ui-li-count">' + data.zones.length + '</span></li>';
			for (var i = 0; i < data.zones.length; i++) {
				var zone_id = String.fromCharCode(97+i+1);
				var name = data.zones[i].name;
				var enabled = data.zones[i].enabled;	
				var pump = data.zones[i].pump;
				var state = data.zones[i].state;
				
				if (enabled == 'on') {
					output += '<li><a href="Zone.htm?id=' + zone_id + '">';
					if (name == '' )
						output += 'Zone' + (i + 1);
					else
						output += name;
					output += '<p>Enabled, Pump: ' + pump + '</p>';
					output += '</a></li>';
				}
			}
			$('#ulListview').empty().append(output).listview('refresh');
          });
        });
		
        function checkAnim(data) {
            //$('#systemz').val(data.run).slider('refresh');
			$('#sched').text('Scheduling is ' + data.run);
            if (data.offtime != null) {
              timeout = (new Date().getTime()) / 1000 + parseInt(data.offtime);
              $('#szone').text(data.onzone);
              $('#sgif').css('display', 'block');
              if (parseInt(data.offtime) == 99999)
                $('#spantime').text("--:--");
              else
                window.setTimeout(function () {updateAnim();}, 1);
            } else
              $('#sgif').css('display', 'none');
        }
		
        function updateAnim() {
          if ($.mobile.activePage.attr("id") != "page1") return;
          var remaining = Math.floor(timeout - (new Date().getTime()) / 1000);
          if (remaining >= 0) {
            $('#spantime').text(
              Math.floor(remaining / 60).toString() + ":" + 
              ("00" + (remaining % 60).toString()).substr(-2));
			  $('#time_').text(
              Math.floor(remaining / 60).toString() + ":" + 
              ("00" + (remaining % 60).toString()).substr(-2));
              window.setTimeout(function () {updateAnim();}, 1000);
          } else {
            $.getJSON("json/state", checkAnim);
          }
        }
      </script>
		<div data-role="panel" id="overlayPanel" data-display="overlay">
			<ul data-role="listview" data-inset="true" class>
				<li data-icon="calendar">
					<a href="Scheds.htm">Schedules</a>
				</li>
				<li data-icon="clock">
					<a href="QSched.htm">Quick</a>
				</li>
				<li data-icon="edit">
					<a href="Zones.htm">Zones</a>
				</li>
				<li data-icon="bullets">
					<a href="Logs.htm">Logs</a>
				</li>
				<li data-icon="gear">
					<a href="Settings.htm">Settings</a>
				</li>
				<li data-icon="info">
					<a href="Advanced.htm">Advanced</a>
				</li>
			</ul>
		</div>
		<!-- /panel -->
		
		<div data-role="header">
			<h3>Sprinklers</h3>
			<a href="#overlayPanel" class="ui-btn ui-btn-left ui-icon-bars ui-btn-icon-notext"></a>
		</div>
		<!-- /header -->
		
		<div data-role="content">
			<div id="sgif" style="display:none">
			  <img src="rainbird.gif" height="70" width="90"><br/>
			  <span id="szone"></span> <span id="spantime">00:00</span>
			</div>
			<ul data-role="listview" data-inset="true" id='ulListview'>
			</ul>
			<div id="timediv"></div>
		</div> 
	  <!-- /content -->
	  
      <div data-role="footer">
        <p><span id="version"></span> &copy; 2013 Richard Zimmerman</p>
      </div>
    </div>
	<!-- /page -->
  </body>

</html>
